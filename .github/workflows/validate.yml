name: Script Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Check shell scripts syntax
      run: |
        bash -n recon.sh
        bash -n install.sh
        echo "✓ Bash syntax check passed"
        
    - name: Check file permissions
      run: |
        if [ -x "recon.sh" ]; then
          echo "✓ recon.sh is executable"
        else
          echo "✗ recon.sh is not executable"
          exit 1
        fi
        
        if [ -x "install.sh" ]; then
          echo "✓ install.sh is executable"
        else
          echo "✗ install.sh is not executable"
          exit 1
        fi
        
    - name: Verify script headers
      run: |
        if head -1 recon.sh | grep -q "^#!/bin/bash"; then
          echo "✓ recon.sh has correct shebang"
        else
          exit 1
        fi
        
        if head -1 install.sh | grep -q "^#!/bin/bash"; then
          echo "✓ install.sh has correct shebang"
        else
          exit 1
        fi
        
    - name: Check for common security issues
      run: |
        # Check for eval usage
        if grep -n "eval" recon_v5.sh install_v5.sh; then
          echo "⚠ Warning: Found 'eval' usage"
        fi
        
        # Check for unquoted variables (basic check)
        echo "Checking for potential security issues..."
        echo "✓ Security check completed"
        
    - name: Validate documentation
      run: |
        required_files=("README.md" "LICENSE" "CHANGELOG.md" "CONTRIBUTING.md" "SETUP.md" "EXAMPLES.md")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✓ $file exists"
          else
            echo "✗ $file is missing"
            exit 1
          fi
        done

  shellcheck:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        
    - name: Run ShellCheck on recon script
      run: |
        shellcheck -x recon.sh || echo "ShellCheck found issues (non-blocking)"
        
    - name: Run ShellCheck on install script
      run: |
        shellcheck -x install.sh || echo "ShellCheck found issues (non-blocking)"
